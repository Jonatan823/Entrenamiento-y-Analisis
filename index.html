<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SLER Visual Lab - Isometría Pura</title>
    <style>
        :root { --accent: #000; --bg: #fff; --sler-blue: #0ea5e9; }
        * { box-sizing: border-box; }
        body { font-family: monospace; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Lateral Derecha: Registro de Binomios */
        .results-sidebar { 
            width: 280px; border-left: 1px solid #eee; padding: 40px 20px; 
            order: 2; display: flex; flex-direction: column; gap: 20px;
        }
        .bin-entry { font-size: 13px; color: #999; line-height: 1.6; }
        .bin-entry.active { color: #000; font-weight: bold; }

        /* Área Central */
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 40px; overflow-y: auto; }
        .header { width: 100%; max-width: 650px; border-bottom: 1px solid #000; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        
        .timers { display: flex; gap: 50px; margin-bottom: 20px; }
        .timer-box { text-align: center; width: 120px; }
        .timer-val { font-size: 28px; font-weight: bold; font-variant-numeric: tabular-nums; }
        .label { font-size: 10px; text-transform: uppercase; color: #666; letter-spacing: 1px; }

        .training-box { 
            width: 100%; max-width: 650px; min-height: 250px;
            padding: 20px; font-size: 21px; line-height: 1.8;
            font-weight: bold; background: #fff; display: none; margin-bottom: 20px;
        }
        .line-box { white-space: pre; display: block; height: 1.8em; }

        .controls { margin-top: 10px; margin-bottom: 30px; }
        button { 
            padding: 15px 60px; cursor: pointer; font-family: monospace; font-weight: bold; 
            background: #000; color: #fff; border: none; font-size: 16px; transition: 0.2s;
        }
        button:hover { background: var(--sler-blue); }
        
        #resultsTable { width: 100%; max-width: 650px; border-collapse: collapse; margin-top: 20px; display: none; }
        #resultsTable th, #resultsTable td { border: 1px solid #000; padding: 12px; text-align: center; font-size: 14px; }
    </style>
</head>
<body>

    <main class="main-content">
        <div class="header">
            <span class="label">SLER LAB: NIVEL <span id="lvlDisplay">1</span></span>
            <span class="label">MODO: PALABRAS ÍNTEGRAS</span>
        </div>

        <div class="timers">
            <div class="timer-box">
                <div class="label">ESTÁNDAR</div>
                <div id="timerStd" class="timer-val">0.000s</div>
            </div>
            <div class="timer-box" id="slerTimerCont" style="opacity: 0.1;">
                <div class="label">SLER</div>
                <div id="timerSler" class="timer-val">0.000s</div>
            </div>
        </div>

        <div id="exerciseBox" class="training-box"></div>

        <div class="controls">
            <button id="mainBtn" onclick="handleFlow()">Iniciar</button>
        </div>

        <table id="resultsTable">
            <thead>
                <tr><th>Nivel</th><th>Renglones</th><th>Std (s)</th><th>SLER (s)</th><th>Δ Mejoría</th></tr>
            </thead>
            <tbody id="statsBody"></tbody>
        </table>
    </main>

    <aside class="results-sidebar">
        <div class="label" style="margin-bottom: 10px;">BINOMIOS PARCIALES</div>
        <div id="bin-1" class="bin-entry">N1: ---</div>
        <div id="bin-2" class="bin-entry">N2: ---</div>
        <div id="bin-3" class="bin-entry">N3: ---</div>
        <div id="bin-4" class="bin-entry">N4: ---</div>
    </aside>

<script>
    let startTime, timerInterval;
    let currentLvl = 1;
    let mode = 'IDLE'; 
    const LIMITE = 42; 
    let finalResults = [];

    // Textos filtrados: Palabras de 1 a 6 caracteres únicamente
    const texts = [
        "El sol da luz hoy. El ojo ve el mar. Es muy azul y fiel. Todo va bien.",
        "Leer es un gran plan. Cada paso es un reto. El modo SLER es muy útil hoy. Ven y mira el sol.",
        "Un buen texto es clave. No hay duda de su valor. El flujo es real y muy veloz en el modo que ves hoy. Es paz.",
        "Si el ojo va y ve bien, todo fluye en paz. No hay saltos ni error. Es un gran avance para tu mente. Lee con fe y gana luz en cada paso. Ver es vivir."
    ];

    function tratarSignos(w, inv) {
        if (!inv) return w;
        let p = w.match(/^[.,;:]+/), s = w.match(/[.,;:]+$/);
        let base = w.replace(/^[.,;:]+|[.,;:]+$/g, '');
        return (s ? s[0] : '') + base + (p ? p[0] : '');
    }

    function motorSinCorte(texto, aplicarSler = false) {
        let mazo = texto.replace(/\s+/g, ' ').trim().split(' ');
        let res = "", par = false;

        while (mazo.length > 0) {
            let lin = "";
            // Agregamos palabras completas mientras quepan en el LIMITE
            while (mazo.length > 0 && (lin.length + mazo[0].length + (lin ? 1 : 0)) <= LIMITE) {
                lin += (lin ? " " : "") + mazo.shift();
            }

            if (aplicarSler && par) {
                let inv = lin.split(' ').map(w => tratarSignos(w, true)).reverse().join(' ');
                let pad = " ".repeat(Math.max(0, LIMITE - inv.length));
                res += `<div class="line-box">${pad}${inv}</div>`;
            } else {
                res += `<div class="line-box">${lin}</div>`;
            }
            par = !par;
        }
        return res;
    }

    function handleFlow() {
        const btn = document.getElementById('mainBtn');
        const box = document.getElementById('exerciseBox');
        if (mode === 'IDLE') {
            mode = 'RUN_STD';
            box.innerHTML = motorSinCorte(texts[currentLvl-1], false);
            box.style.display = 'block';
            btn.innerText = "Detener";
            startClock('timerStd');
        } else if (mode === 'RUN_STD') {
            stopClock();
            mode = 'WAIT_SLER';
            box.style.display = 'none';
            btn.innerText = "Iniciar SLER";
            document.getElementById('slerTimerCont').style.opacity = "1";
        } else if (mode === 'WAIT_SLER') {
            mode = 'RUN_SLER';
            box.innerHTML = motorSinCorte(texts[currentLvl-1], true);
            box.style.display = 'block';
            btn.innerText = "Detener";
            startClock('timerSler');
        } else if (mode === 'RUN_SLER') {
            stopClock();
            saveAndLog();
            if (currentLvl < 4) { currentLvl++; resetForNext(); } 
            else { finishAll(); }
        }
    }

    function startClock(id) {
        startTime = performance.now();
        timerInterval = setInterval(() => {
            document.getElementById(id).innerText = ((performance.now() - startTime) / 1000).toFixed(3) + "s";
        }, 10);
    }

    function stopClock() { clearInterval(timerInterval); }

    function saveAndLog() {
        const std = document.getElementById('timerStd').innerText;
        const sler = document.getElementById('timerSler').innerText;
        const lines = document.getElementById('exerciseBox').querySelectorAll('.line-box').length;
        finalResults.push({ lvl: currentLvl, lines, std, sler });
        const entry = document.getElementById(`bin-${currentLvl}`);
        entry.innerHTML = `N${currentLvl}: STD ${std} | SLER ${sler}`;
        entry.classList.add('active');
    }

    function resetForNext() {
        mode = 'IDLE';
        document.getElementById('exerciseBox').style.display = 'none';
        document.getElementById('lvlDisplay').innerText = currentLvl;
        document.getElementById('timerStd').innerText = "0.000s";
        document.getElementById('timerSler').innerText = "0.000s";
        document.getElementById('slerTimerCont').style.opacity = "0.1";
        document.getElementById('mainBtn').innerText = "Iniciar";
    }

    function finishAll() {
        document.getElementById('exerciseBox').style.display = 'none';
        document.getElementById('mainBtn').innerText = "Test Finalizado";
        document.getElementById('mainBtn').disabled = true;
        const table = document.getElementById('resultsTable');
        const body = document.getElementById('statsBody');
        table.style.display = 'table';
        finalResults.forEach(r => {
            let s1 = parseFloat(r.std), s2 = parseFloat(r.sler);
            let imp = (((s1 - s2) / s1) * 100).toFixed(1) + "%";
            body.innerHTML += `<tr><td>${r.lvl}</td><td>${r.lines}</td><td>${r.std}</td><td>${r.sler}</td><td>${imp}</td></tr>`;
        });
    }
</script>
</body>
</html>
